# Notification Pattern

The Notification pattern is one of the [6 Integration Pattern Templates](https://integrationworks.sharepoint.com/sites/MicrosoftAzureGuild/SitePages/Integration-Pattern-Templates.aspx). A notification is a fire-and-forget pattern that is used to perform notifications about data changes. This pattern should be used when a provider is notifying an interested consumer that an event has taken place on their data.

This patterns uses a Function App which runs on an App Service plan. The Function App has two functions which act as the provider and consumer. It should be noted that the Function App just facilitates the pattern but is not part of it and could be interchanged with any applications. For this example, it simulates a delivery status update.

The Function app has a function called `delivery_update` which acts as the provider and can be triggered by an HTTP Post request. The function takes the delivery update from the request's body and sends a message containing the update to a Service Bus queue. When a message is in this queue an event is created. The consumer function, `delivery_update_sub`, is triggered by these events and the reads the message(s) from the queue.

## Parameters

All file parameters are injected using [dev-vars.tfvars](./tfvars/dev-vars.tfvars).

**Note. If this, repo was not created by backstage, some variables populated with input variables in the form ``. These variables should be replaced with concrete values. If this repo was generated by backstage, they will be populated.**

| Parameter| Description|
|----------|------------|
|`location`| The Azure region that resources will be deployed to|
|`resource_group_name`| The name of an existing Resource Group that the resources will be deployed to|
|`function_app_name`| The name of the Function App resource to be deployed (Must be unique) |
|`storage_account_name`| The name for the Storage Account resource. |
|`app_sku`| Defines the tier of the Function App resource|
|`app_service_plan_name`|The name for the App Service Plan resource |
|`function_app_repo`| The URL for the repo containing the Function App code|
|`function_app_package_name`| Name for the zip package created from the Function App repo files |
|`application_insights_name`| Application Insights resource name|
|`app_settings`|Function App application settings (map of Key-Value pairs)|
|`system_topic_name`|Event Grid System Topic resource name|
|`system_topic_type`| Event Grid System Topic resource type |
| `event_grid_sub_name`|Event Grid Topic Subscription name|
|`event_delivery_schema` | Event Grid delivery schema |
|`service_bus_namespace_name`| Service Bus Namespace resource name|
|`service_bus_queue_name`|Service Bus Namespace Queue resource name|
|`service_bus_sku`| Tier of Service Bus |

## Modules and Resources

### Resource Group

The first resource is a data source. This allows Terraform to get information defined outside of Terraform. In this case, it gets an Azure Resource Group with the name specified in the variable `var.resource_group_name`. This allows us to use the Resource Group's attributes such as `name` and `id`.

### Service Bus Namespace and Queue

The `service_bus_queue` module provisions a Service Bus Namespace and a Queue within the Namespace. These are used to queue messages. They are defined in [/modules/resources/service-bus/main.tf](../../modules/resources/service-bus/main.tf).

### Function App

The `function_app` module provisions the Function App, App Service Plan, Application Insights and Storage Account resources. Each of these resources are required for a Function App to run. This module also clones the [function app code](https://github.com/james-knott-iw/notification-fa) and deploys it to Azure using zip deployment. This module is defined in [/modules/resources/function-app-zip-deploy/main.tf](../../modules/resources/function-app-zip-deploy/main.tf).

### Event Grid System Topic and Subscription

The `event_grid_sub` module provisions an Event Grid System Topic and an Event Grid Subscription. This is defined in [/modules/resources/event-grid-system-topic-sub/main.tf](../../modules/resources/event-grid-system-topic-sub/main.tf).

## Running the Template

### Requirements

- Azure CLI
- Terraform CLI
- Git
- An Azure Resource Group

### Steps

*Note. If this template has not been generated by backstage, run the Terraform locally and comment out the remote backend code in [backend.tf](./backend.tf)*.

From the root of the repo enter the directory [/terraform/patterns/push-based/notification](/terraform/patterns/push-based/notification/):

```bash
cd terraform/patterns/push-based/notification/
```

#### Clone Function App Code

Clone the Function App code, which is in a seperate repo, into a directory named the same as the parameter `function_app_package-name`. This variable is defined in [dev-vars.tfvars](./tfvars/dev-vars.tfvars).

```bash
git clone https://github.com/james-knott-iw/notification-fa.git <function_app_package_name>
```

#### Terraform Deployment

Initialise Terraform:

```bash
terraform init
```

Run Terraform plan:

```bash
terraform plan -var-file="./tfvars/dev-vars.tfvars" -out main.tfplan
```

After a successful plan, the terminal will output all the proposed changes.  

Apply the Terraform plan:

```bash
terraform apply "main.tfplan"
```

You should then see terminal output describing what resources are currently being created and the elapsed time.

For example:

```bash
module.service_bus_queue.azurerm_servicebus_namespace.this: Creating...
module.service_bus_queue.azurerm_servicebus_namespace.this: Still creating... [10s elapsed]
```

You can also view your resources in the [Azure Portal](https://portal.azure.com) under the resource group.

#### Test the Functions

First navigate to the Function App resource in the Azure portal. In the side-menu open the `Log Stream` tab and wait for it to connect.

Then make a POST request to the following url with a delivery status in the body. Where `<FUNCTION_APP_NAME>` and `<FUNCTION_NAME>` are the name of the function app and the function, respectively. In this case, they are `notif-delivery-fa` and `delivery_update`:

Example urls:

```bash
https://<FUNCTION_APP_NAME>.azurewebsites.net/api/<FUNCTION_NAME>
```

```bash
https://notif-delivery-fa.azurewebsites.net/api/delivery_update
```

Example body:

```JSON
{  
      "Status": "Delivered"
}
```

#### Remove Created Resources

To remove the provisioned resources run the following command:

```
terraform destroy -auto-approve -var-file="tfvars/dev-vars.tfvars"
```
